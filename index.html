<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wusphinx.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="just for fun!">
<meta property="og:url" content="http://wusphinx.github.io/index.html">
<meta property="og:site_name" content="just for fun!">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="wusphinx">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://wusphinx.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>just for fun!</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a32e8edc49025ee79314023ae6ab9e82";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="just for fun!" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">just for fun!</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">凡事有交代，件件有着落，事事有回音</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/wusphinx" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://wusphinx.github.io/2020/12/25/IaC%E5%B7%A5%E5%85%B7%E4%B9%8BAnsible/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wusphinx">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="just for fun!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/25/IaC%E5%B7%A5%E5%85%B7%E4%B9%8BAnsible/" class="post-title-link" itemprop="url">IaC工具之Ansible</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-12-25 11:28:08 / 修改时间：11:30:23" itemprop="dateCreated datePublished" datetime="2020-12-25T11:28:08+08:00">2020-12-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a>
                </span>
            </span>

          
            <span id="/2020/12/25/IaC%E5%B7%A5%E5%85%B7%E4%B9%8BAnsible/" class="post-meta-item leancloud_visitors" data-flag-title="IaC工具之Ansible" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Ansible是什么？"><a href="#Ansible是什么？" class="headerlink" title="Ansible是什么？"></a>Ansible是什么？</h1><blockquote>
<p>Ansible是一种开源软件配置，配置管理和应用程序部署工具，可将基础结构作为代码启用。它可以在许多类Unix系统上运行，并且可以配置类Unix系统和Mi​​crosoft Windows。它包含自己的声明性语言来描述系统配置。Ansible由Michael DeHaan编写，并于2015年被Red Hat收购</p>
</blockquote>
<p>如上所述，Ansible是一种开源软件<strong>配置</strong>工具，那它可以用来做什么</p>
<h1 id="Ansible可以用来做什么？"><a href="#Ansible可以用来做什么？" class="headerlink" title="Ansible可以用来做什么？"></a>Ansible可以用来做什么？</h1><h2 id="安装Ansible"><a href="#安装Ansible" class="headerlink" title="安装Ansible"></a>安装Ansible</h2><p>在Mac下直接安装即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install ansible</span><br></pre></td></tr></table></figure>
<p>版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible --version</span><br><span class="line">ansible 2.10.3</span><br></pre></td></tr></table></figure>
<h2 id="Ansible主机管理"><a href="#Ansible主机管理" class="headerlink" title="Ansible主机管理"></a>Ansible主机管理</h2><p>自己手头有两台虚拟机，一台是本地使用<a target="_blank" rel="noopener" href="https://multipass.run/">multipass</a>的虚拟机，一台是自己在腾讯去上买的虚拟机，先配置好ssh名密登录，然后配置好Ansible管理的主机，新建配置文件<code>/etc/ansible/hosts</code>，文件配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">42.192.129.128 ansible_ssh_user&#x3D;ubuntu</span><br><span class="line">[node]</span><br><span class="line">192.168.64.12 ansible_ssh_user&#x3D;ubuntu</span><br></pre></td></tr></table></figure>
<p>这份配置还是非常清晰易懂的：</p>
<ul>
<li><code>[webservers]</code>是可以理解分组，<code>webservers</code>就是组名</li>
<li><code>42.192.129.128</code>自然主机的ip地址了</li>
<li><code>ansible_ssh_user</code>，故名思意，ssh登录用户名</li>
</ul>
<p>运行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ansible all -m ping</span><br><span class="line">192.168.64.12 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;&#x2F;usr&#x2F;bin&#x2F;python3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">[DEPRECATION WARNING]: Distribution Ubuntu 18.04 on host 42.192.129.128 should use &#x2F;usr&#x2F;bin&#x2F;python3,</span><br><span class="line"> but is using &#x2F;usr&#x2F;bin&#x2F;python for backward compatibility with prior Ansible releases. A future</span><br><span class="line">Ansible release will default to using the discovered platform python for this host. See</span><br><span class="line">https:&#x2F;&#x2F;docs.ansible.com&#x2F;ansible&#x2F;2.10&#x2F;reference_appendices&#x2F;interpreter_discovery.html for more</span><br><span class="line">information. This feature will be removed in version 2.12. Deprecation warnings can be disabled by</span><br><span class="line">setting deprecation_warnings&#x3D;False in ansible.cfg.</span><br><span class="line">42.192.129.128 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;&#x2F;usr&#x2F;bin&#x2F;python&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这条<code>ansible all -m ping</code>中<code>-m</code>的含义是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-m MODULE_NAME, --module-name MODULE_NAME</span><br><span class="line">                    module name to execute (default&#x3D;command)</span><br></pre></td></tr></table></figure>
<p>也就是运行ansible的模块<code>ping</code>一下所有分组（注意，这里的ping并不是linux命令ping，面是ansible的一个模块实现了与linux下ping类似的功能），也可以指定分组如指定<strong>node</strong>分组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ansible node -m ping</span><br><span class="line">192.168.64.12 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;&#x2F;usr&#x2F;bin&#x2F;python3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这几条命令使用下来，可以知道ansible能通过ssh建立连接批量管理远程主机，试想一下，1000台主机的情况下，如果没有ansible，上述ping操作可能要重复敲击1000次，或者写脚本配置完成ansible的类似功能，将操作抽象成配置，减少重复，这或许就是<strong>ansible</strong>这类工具诞生的其中一个动机吧。</p>
<h2 id="Ansible的Playbook功能"><a href="#Ansible的Playbook功能" class="headerlink" title="Ansible的Playbook功能"></a>Ansible的Playbook功能</h2><blockquote>
<p>Ansible脚本的名字叫Playbook，使用的是YAML的格式，文件以yml结尾</p>
</blockquote>
<p>实现上例中的相同功能，可编写<code>demo.yml</code>如下</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">ubuntu</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ping</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">ping:</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行之</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ansible-playbook demo.yml</span><br><span class="line"></span><br><span class="line">PLAY [node] *****************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************</span><br><span class="line">ok: [192.168.64.12]</span><br><span class="line"></span><br><span class="line">TASK [ping test] ************************************************************************************</span><br><span class="line">ok: [192.168.64.12]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************</span><br><span class="line">192.168.64.12              : ok&#x3D;2    changed&#x3D;0    unreachable&#x3D;0    failed&#x3D;0    skipped&#x3D;0    rescued&#x3D;0    ignored&#x3D;0</span><br></pre></td></tr></table></figure>
<p>很简单的样子，事实上也确实简单，因为yml配置的描述也相当清晰。虽然此处只是一个简的例子，不过也可以看出Playbook其实就是ansible的的一种”脚本”形式，这种声明式配置足够友好（k8s的声明式对象配置倒是与此非常相似，应该是同宗同源）。</p>
<h2 id="Host-Inventory"><a href="#Host-Inventory" class="headerlink" title="Host Inventory"></a>Host Inventory</h2><p>上术示例主机都是使用默认路径的配置，其实有可以动态自定义主机及分组配置，而且使用yml格式（我真是喜欢yml格式）定义文件<code>host.yml</code>如下所示</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">--- </span></span><br><span class="line"><span class="attr">all:</span></span><br><span class="line">  <span class="attr">children:</span></span><br><span class="line">    <span class="attr">webservers:</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="attr">42.192.129.128:</span></span><br><span class="line">          <span class="attr">ansible_ssh_user:</span> <span class="string">ubuntu</span></span><br><span class="line">    <span class="attr">node:</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="attr">192.168.64.12:</span></span><br><span class="line">          <span class="attr">ansible_ssh_user:</span> <span class="string">ubuntu</span></span><br></pre></td></tr></table></figure>
<p>然后使用命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i host.yml -m ping</span><br></pre></td></tr></table></figure>
<p>结果与上例无异，个人更喜欢yml这种写法，结构更清晰，当然这是要在熟悉文档及其用法的基础上。</p>
<h2 id="ansible-console"><a href="#ansible-console" class="headerlink" title="ansible-console"></a>ansible-console</h2><p>ansible为用户提供的交互式工具，可以方便地连接远程主机使用shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜ ansible-console node</span><br><span class="line">Welcome to the ansible console.</span><br><span class="line">Type help or ? to list commands.</span><br><span class="line"></span><br><span class="line">whoami@node (1)[f:5]$ lsb_release -a</span><br><span class="line">192.168.64.12 | CHANGED | rc&#x3D;0 &gt;&gt;</span><br><span class="line">Distributor ID:	Ubuntu</span><br><span class="line">Description:	Ubuntu 18.04.3 LTS</span><br><span class="line">Release:	18.04</span><br><span class="line">Codename:	bionicNo LSB modules are available.</span><br></pre></td></tr></table></figure>
<p>发现ansible真挺好用，如果平台用多台虚拟机的话，也可以使用ansible来管理与交互，整体下来学习成本不高，使用却非常方便。</p>
<h2 id="条件控制"><a href="#条件控制" class="headerlink" title="条件控制"></a>条件控制</h2><p>就像写代码一样，有时候做一些交互操作的时候希望有满足某些条件再执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: node</span><br><span class="line">  remote_user: ubuntu</span><br><span class="line">  tasks:</span><br><span class="line">  - name: ping test</span><br><span class="line">    ping: </span><br><span class="line">    when: ansible_os_family &#x3D;&#x3D; &quot;RedHat&quot;</span><br></pre></td></tr></table></figure>
<p>用ansible-playbook运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook demo.yml</span><br><span class="line"></span><br><span class="line">PLAY [node] ***********************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ************************************************************************************************************************************</span><br><span class="line">ok: [192.168.64.12]</span><br><span class="line"></span><br><span class="line">TASK [ping test] ******************************************************************************************************************************************</span><br><span class="line">skipping: [192.168.64.12]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ************************************************************************************************************************************************</span><br><span class="line">192.168.64.12              : ok&#x3D;1    changed&#x3D;0    unreachable&#x3D;0    failed&#x3D;0    skipped&#x3D;1    rescued&#x3D;0    ignored&#x3D;0</span><br></pre></td></tr></table></figure>
<p>因为我的虚拟机是Ubuntu，所以在<code>ansible_os_family == &quot;RedHat&quot;</code>为false, 任务就跳过执行了，改为<code>Debian</code>就能正确执行了。</p>
<h2 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h2><p>这个功能很有用，特别是需要批量操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: node</span><br><span class="line">  remote_user: ubuntu</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Install the package &quot;nmap&quot;</span><br><span class="line">    become: true</span><br><span class="line">    apt:</span><br><span class="line">      name: nmap</span><br></pre></td></tr></table></figure>
<p>注意此处<code>become: true</code>是为了权限升级，可理解为<code>sudo</code>操作。</p>
<hr>
<p>此篇为开坑之作，还有一些高级用法Roles、<code>ansible-galaxy</code>、<code>ansible-vault</code>等就不一次展开了，通过简单的使用，ansible解决了批量操作、运维操作重用等功能，描述性配置非常强大，基本等同于编程，这与一些CI/CD平台如gitlab等倒是非常相似的，文档也很丰富且全面。</p>
<p>未完，待续……</p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Ansible_(software)">Ansible wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://ansible-tran.readthedocs.io/en/latest/docs/intro.html">Ansible中文权威指南</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903734233792519">ssh免密登录</a></li>
<li><a target="_blank" rel="noopener" href="https://getansible.com/begin/ansiblemo_kuai_module">Ansible模块</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://wusphinx.github.io/2020/12/08/Docker%E7%9A%84%E4%BA%8C%E6%AC%A1%E6%AD%BB%E4%BA%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wusphinx">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="just for fun!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/08/Docker%E7%9A%84%E4%BA%8C%E6%AC%A1%E6%AD%BB%E4%BA%A1/" class="post-title-link" itemprop="url">Docker的二次死亡</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-08 10:35:24" itemprop="dateCreated datePublished" datetime="2020-12-08T10:35:24+08:00">2020-12-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-25 11:30:23" itemprop="dateModified" datetime="2020-12-25T11:30:23+08:00">2020-12-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BF%BB%E8%AF%91/" itemprop="url" rel="index"><span itemprop="name">翻译</span></a>
                </span>
            </span>

          
            <span id="/2020/12/08/Docker%E7%9A%84%E4%BA%8C%E6%AC%A1%E6%AD%BB%E4%BA%A1/" class="post-meta-item leancloud_visitors" data-flag-title="Docker的二次死亡" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="似曾相识"><a href="#似曾相识" class="headerlink" title="似曾相识"></a>似曾相识</h2><p>时间并没有过去多久，但就是感觉Docker的历史很长的似的。我是在2015年夏天加入红帽的，也就是OpenShift 3.0 GA的那个夏天。这是一个了不起的事件，因为它标志着将平台重新设计到Kubernetes上，而Kubernetes本身也刚刚发布了v1.0版本（这与GKE正式GA的时间段相同，如果你能相信它有那么老的话）。和很多人一样，我对Kubernetes和OpenShift一无所知，对Docker也绝对不了解。一直到秋天，我对这三者才有了较深入的了解，很自然地在几个月后就爱上了这个生态系统。</p>
<p>第二年春天，是我第一次 “真正”接触Docker公司。我没有参加2016年的红帽峰会，但我清楚地记得，那一年是Docker真正第一次对红帽OpenShift做出对外对抗的举动，是在红帽自己的活动上。他们当时送出了以下衬衫。<br><img src="/images/docker-attack.png" alt="image.png"></p>
<p>简单总结一下，这是对红帽将补丁打到旧版本软件的模式的抗议（即所谓的”企业支持”）。红帽当时发布的Docker版本只是略微落后于最新版，而Docker发布的是他们最新的版本。我不会去讨论为什么这很重要的细节，因为今天仍然有一个争论，那就是对一个组织来说，回溯补丁与保持在最新版本上哪个选择更优（后者在最近一段时间已经变得相当好）。这一点意义重大，因为直到那个时候，Docker还是OpenShift吹牛过程中不可或缺的一部分。我们把一个和另一个一起卖掉，我们大多数人甚至所有的人的基本假设是：Docker只是一个伟大的技术。回想起来，这应该是意料之中的，因为Docker公司开始商业化之后，突然间就不再只是一项伟大的技术了。</p>
<h2 id="一切或许早已注定"><a href="#一切或许早已注定" class="headerlink" title="一切或许早已注定"></a>一切或许早已注定</h2><p>早期的平台大战，我称之为平台大战，主要集中在OpenShift、Docker和Pivotal周围。Pivotal在早期就已经在企业组织中取得了重大进展，这是有充分理由的：平台体验相当不错。再加上Pivotal实验室，你就有了一些很好的机会。Docker是后起之秀。它是行业的宠儿，大放异彩，它拥有每个人都想要的技术，或者每个人都已经在使用的技术。Kubernetes当时还是个问号。我花了很多时间与组织讨论Kubernetes的核心和细节，以及为什么它很重要，或者更准确地说：为什么它应该对他们很重要。Docker敲打OpenShift的举动，迫使红帽开始关注Kubernetes和Linux，而不是其他任何东西。这招奏效了，业界也跟上了，于是Kubernetes就火了。</p>
<p>还以为自己处于行业宠儿状态的Docker迅速做出了反应: 推出了Docker Swarm，众所周知，它始终没有真正流行起来。Swarm最终淹没在整个行业对Kubernetes的关注中，这是它第一次死亡：它输掉了平台大战，成为云原生生态系统中的第一个牺牲品。2016年下半年，才是Kubernetes真正边缘化Swarm的时候。这一点，在第二年春天的DockerCon2017大会上，当演讲者在大舞台上展示Docker与Kubernetes的整合时，主题演讲演示就能证明。值得注意的是，那是DockerCon最后一次大放异彩的”大”事件。从那以后，就是Kubernetes/CNCF的展会的天下了。</p>
<h2 id="Docker的技术债务"><a href="#Docker的技术债务" class="headerlink" title="Docker的技术债务"></a>Docker的技术债务</h2><p>就在之前，Docker还是Kubernetes不可或缺的一部分，它们的关系就像下面描绘的那样：<br><img src="/images/docker-chain.png" alt="image.png"></p>
<p>在Kubernetes过去的19个版本中，一直使用的就是这个链条。所有的一切，仅仅是为了起动一个有容器的pod。Docker从必需品变成了技术债。而在这一切中，社区一直辛苦到现在，Docker将在下一个版本1.20中被废弃。社区已经（理所当然地）背负了多年Docker的技术债务，以确保在docker守护进程无处不在的情况下，行业有它所需要的最无缝的体验。以下是已经存在了一段时间，但将在1.20及以后正式进入启用的调用链：<br><img src="/images/containerd-chain.png" alt="image.png"></p>
<p>这是一个伟大的简化，也是对一致性的回归。为了帮助大家直观地了解为什么要这样做，我鼓励大家把Docker看作是容器之上的一个平台抽象，而容器只是一些Linux结构的集合体。这种抽象的一部分涉及到docker平台和containerd之间的整合，后者今天可以说是作为最流行的容器运行时而存在。Docker从来不是运行时。Docker只是让containerd和其他Linux构造变得容易工作，这样容器管理就会变得轻而易举。而不是用十几行代码来创建和部署一个正在运行的容器，你需要的只是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run</span><br></pre></td></tr></table></figure>
<p>但和任何平台一样，这种便利性也伴随着大量的臃肿和技术债务。尤其是随着时间的推移。docker的移除和containerd的优化标志着云原生环境的一种文化转变。这些都不是要否定Docker公司。如果没有Docker公司，Kubernetes就不会有今天的成就。这是一个事实。Docker公司推动的技术和竞争是这个行业有史以来最棒的事情。现在，就将开源技术转化为盈利的商业模式而言，Docker Inc很可能会被研究成一个警示性的昙花一现。不过，我们还是要分清公司的贡献与商业模式。目前，Docker平台剩下的，是它在Kubernetes平台中的影子。尽管它确实在CI/CD生态系统内强势生存，而且，从表面上看，<code>Dockerfile</code>也是事实上的标准。这证明了Docker公司曾经拥有的力量，它的技术活得远远超过了公司的淘汰期，直到社区创新赶上了它。由于平台上多年来的臃肿，平台左侧的其他领域摆脱Docker守护进程的债务，其实只是时间问题。</p>
<p>虽然它曾有过一段神奇的历程，对行业产生过不可磨灭的影响，但实际上，Docker已经死了……</p>
<p>原文链接：<a target="_blank" rel="noopener" href="https://www.tariqislam.com/posts/kubernetes-docker-dep/">https://www.tariqislam.com/posts/kubernetes-docker-dep/</a></p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1579900">https://cloud.tencent.com/developer/article/1579900</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://wusphinx.github.io/2020/12/06/prometheus%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8A%A8%E6%80%81%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wusphinx">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="just for fun!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/06/prometheus%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8A%A8%E6%80%81%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">prometheus如何实现配置文件动态管理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-06 16:34:55" itemprop="dateCreated datePublished" datetime="2020-12-06T16:34:55+08:00">2020-12-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-25 11:30:23" itemprop="dateModified" datetime="2020-12-25T11:30:23+08:00">2020-12-25</time>
              </span>

          
            <span id="/2020/12/06/prometheus%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8A%A8%E6%80%81%E7%AE%A1%E7%90%86/" class="post-meta-item leancloud_visitors" data-flag-title="prometheus如何实现配置文件动态管理" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>因为prometheus并不提供配置文件动态更新的API，所以使用<strong>文件</strong>作为prometheus服务发现的情况下，只能通过修改文件的方式达到更新配置的目的，<br>常规步骤如下：</p>
<ol>
<li>修改配置文件</li>
<li>重启prometheus服务（调用<code>/-/reload</code>使得配置变更生效，前提是开启了<code>--web.enable-lifecycle</code>支持）</li>
</ol>
<p>一般修改配置如告警规则等属于低频事件，修改保持了就需要重启使之生效，那其实期望这两步能够合二为一，即：<br>修改完配置立刻应用更新。</p>
<p>promethesu本身也提供这一功能，配置关键字为<code>file_sd_configs</code>，实现这一功能的引入的项目为<a target="_blank" rel="noopener" href="https://github.com/fsnotify/fsnotify">fsnotify</a></p>
<blockquote>
<p>Go的文件系统通知</p>
</blockquote>
<p>要实现以上两步合二为一的功能，很容易想到以下做法：</p>
<ol>
<li>监听文件变化</li>
<li>处理文件变化</li>
</ol>
<p>可以先来看看fsnotify的示例代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/fsnotify/fsnotify&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	watcher, err := fsnotify.NewWatcher()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> watcher.Close()</span><br><span class="line"></span><br><span class="line">	done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> event, ok := &lt;-watcher.Events:</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">				log.Println(<span class="string">&quot;event:&quot;</span>, event)</span><br><span class="line">				<span class="keyword">if</span> event.Op&amp;fsnotify.Write == fsnotify.Write &#123;</span><br><span class="line">					log.Println(<span class="string">&quot;modified file:&quot;</span>, event.Name)</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="keyword">case</span> err, ok := &lt;-watcher.Errors:</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">				log.Println(<span class="string">&quot;error:&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	err = watcher.Add(<span class="string">&quot;/tmp/foo&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	&lt;-done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到监听文件是由<code>watcher.Add(&quot;/tmp/foo&quot;)</code>完成的，对文件变化事件的处理是由其中的起的<code>Goroutine</code>完成的。看到这里其实可以知道关键在于监听这一步是如何实现的，那就来debug一下吧，笔者环境为<code>go1.14.4 darwin/amd64</code>，使用VSCode进行代码调试，代码目录为下（为方便调试，建议将项目依赖使用<code>go mod vendor</code>打入vendor目录中）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── main.go</span><br><span class="line">├── notes.md</span><br><span class="line">└── vendor</span><br><span class="line">    ├── github.com</span><br><span class="line">    ├── golang.org</span><br><span class="line">    └── modules.txt</span><br></pre></td></tr></table></figure>
<p>调试配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot;: &quot;fsnotify&quot;,</span><br><span class="line">            &quot;type&quot;: &quot;go&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;mode&quot;: &quot;auto&quot;,</span><br><span class="line">            &quot;program&quot;: &quot;$&#123;workspaceRoot&#125;&#x2F;main.go&quot;,</span><br><span class="line">            &quot;env&quot;: &#123;&#125;,</span><br><span class="line">            &quot;args&quot;: []</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>单步调试的过程其实并不是特别直观，这里使用使用一个工具叫做<code>go-callvis</code>来全局看一下文件监听的整个调用链，可以注意到有一个<code>register</code>的函数调用如下：<br><img src="/images/fsnotify.webp" alt="fsnotify"></p>
<p>关键代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; register events with the queue</span><br><span class="line">func register(kq int, fds []int, flags int, fflags uint32) error &#123;</span><br><span class="line">	changes :&#x3D; make([]unix.Kevent_t, len(fds))</span><br><span class="line"></span><br><span class="line">	for i, fd :&#x3D; range fds &#123;</span><br><span class="line">		&#x2F;&#x2F; SetKevent converts int to the platform-specific types:</span><br><span class="line">		unix.SetKevent(&amp;changes[i], fd, unix.EVFILT_VNODE, flags)</span><br><span class="line">		changes[i].Fflags &#x3D; fflags</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; register the events</span><br><span class="line">	success, err :&#x3D; unix.Kevent(kq, changes, nil, nil)</span><br><span class="line">	if success &#x3D;&#x3D; -1 &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处能够注意到<code>Kevent</code>函数，到此处可以打住了（后绪的内容内容涉及cgo、动态链接细节，那是一块内容，跟此文关系不大），这是unix下基于kqueue的内核事件的系统调用。<br>至此，我们有了大致的脉络：</p>
<ol>
<li>监听kevent事件（在<code>NewWatcher</code>起一个goroutine专门读取kevent， <code>100ms</code>一次）</li>
<li>注册文件监控</li>
<li><code>main</code>中的goroutine即为对监听事件做出响应</li>
</ol>
<p>其实看到这里，关键点就在于kevent了，跟操作系统内核打交道，比较有意思的一点是kevent的注册跟监底层调用是同一个函数，即：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Kevent</span><span class="params">(kq <span class="keyword">int</span>, changes, events []Kevent_t, timeout *Timespec)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> change, event unsafe.Pointer</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(changes) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		change = unsafe.Pointer(&amp;changes[<span class="number">0</span>])</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(events) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		event = unsafe.Pointer(&amp;events[<span class="number">0</span>])</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> kevent(kq, change, <span class="built_in">len</span>(changes), event, <span class="built_in">len</span>(events), timeout)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只不过在注册监听的时候参数<code>events</code>与<code>timeout</code>都为<code>nil</code>。用vim打开<code>/tmp/foo</code>并增加一行，程序运行结果为下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2020&#x2F;12&#x2F;06 16:25:45 event: &quot;&#x2F;tmp&#x2F;foo&quot;: CHMOD</span><br><span class="line">2020&#x2F;12&#x2F;06 16:25:45 event: &quot;&#x2F;tmp&#x2F;foo&quot;: WRITE</span><br><span class="line">2020&#x2F;12&#x2F;06 16:25:45 modified file: &#x2F;tmp&#x2F;foo</span><br><span class="line">2020&#x2F;12&#x2F;06 16:25:45 event: &quot;&#x2F;tmp&#x2F;foo&quot;: CHMOD</span><br></pre></td></tr></table></figure>
<p>总结，两个goroutine，一个读，一个写，这是典型的顾客-消费者模型，关键在于对操作系统kevent的运用。</p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Kqueue">https://zh.wikipedia.org/wiki/Kqueue</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/fsnotify/fsnotify">https://github.com/fsnotify/fsnotify</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/TrueFurby/go-callvis">https://github.com/TrueFurby/go-callvis</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebsd.org/cgi/man.cgi?query=kevent&amp;sektion=2">https://www.freebsd.org/cgi/man.cgi?query=kevent&amp;sektion=2</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://wusphinx.github.io/2020/11/29/%E4%B8%BA%E4%BB%80%E4%B9%88IaC%E6%98%AF%E4%B8%AA%E5%A5%BD%E4%B8%BB%E6%84%8F%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wusphinx">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="just for fun!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/29/%E4%B8%BA%E4%BB%80%E4%B9%88IaC%E6%98%AF%E4%B8%AA%E5%A5%BD%E4%B8%BB%E6%84%8F%EF%BC%9F/" class="post-title-link" itemprop="url">为什么IaC是个好主意？</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-29 18:43:55" itemprop="dateCreated datePublished" datetime="2020-11-29T18:43:55+08:00">2020-11-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-25 11:30:23" itemprop="dateModified" datetime="2020-12-25T11:30:23+08:00">2020-12-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a>
                </span>
            </span>

          
            <span id="/2020/11/29/%E4%B8%BA%E4%BB%80%E4%B9%88IaC%E6%98%AF%E4%B8%AA%E5%A5%BD%E4%B8%BB%E6%84%8F%EF%BC%9F/" class="post-meta-item leancloud_visitors" data-flag-title="为什么IaC是个好主意？" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="IaC是什么？"><a href="#IaC是什么？" class="headerlink" title="IaC是什么？"></a>IaC是什么？</h1><p>IaC即Infrastructure as Code的简称，通常提到基础设施，会想到虚拟机、服务器、数据库、防火墙等词汇，在k8s一统江湖、云原生大行其道的当下，基础设施这一层已悄然发生的变化，在我的理解里k8s已隐隐成为未来的基础设施了。</p>
<ul>
<li>应用</li>
<li>容器</li>
<li>k8s</li>
<li>虚拟机</li>
<li>物理机</li>
</ul>
<h1 id="IaC能带来什么好处？"><a href="#IaC能带来什么好处？" class="headerlink" title="IaC能带来什么好处？"></a>IaC能带来什么好处？</h1><p>前面提到k8s是基础设施，那基础设施始终是为应用服务的。当一个应用开发人员开发完毕以后，部署这一步在以前是由运维完成的，运维的操作步骤无外乎以下几点：</p>
<ol>
<li>拉取代码</li>
<li>编译打包</li>
<li>配置部署</li>
<li>交付测试</li>
</ol>
<p>这是以前套路，即使放到现在，也有不少人在用，就笔者的从业经验来说，不少开发人员并不知道自己的应用在生产是如何部署运行的。这在一定情况下并不是一件坏事，因为各尽其职，开发完成功能，运维负责部署，测试负责验证，每一个环节都是一个gap。可以试想以下场景：</p>
<ol>
<li>传统部署或者可以说是非容器化部署，因为生产某服务demo负载过高，需要进行水平扩容，增加实例，将实例注册到负载均衡服务器，然后使扩容生效。规范一点，需要提工单，有操作日志/记录，比较糙或者是紧急的情况下可能只是口头描述，然后线上操，这是完全有可能的，当然，如果要缩容，需要进行反向操作。</li>
<li>如果服务部署是容器化的，容器化解决的是环境一致的问题，既然是解决环境一致的问题，那在开发环境当然也应该容器化，比较奇怪的是，因为职能的不同，不少开发并不懂容器化，服务项目Repo里面自然也不包括<code>Dockerfile</code>，当然更加不会有k8s的资源描述文件（或者是Helm的Chart包）了（这到底是不是个问题呢，因人而异，以我的角度来讲，这是个问题）。<br>对于场景1，我认为问题在于变动没有追溯或不易追溯，come on, 明明git就是一个非常好的追溯工具好不好，当然，如果基础设施是k8s，定义好HPA就可以了，如下所示：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: autoscaling&#x2F;v2beta1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: demo</span><br><span class="line">spec:</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: apps&#x2F;v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: demo</span><br><span class="line">  minReplicas: 1</span><br><span class="line">  maxReplicas: 3</span><br><span class="line">  metrics:</span><br><span class="line">  - type: Resource</span><br><span class="line">    resource:</span><br><span class="line">      name: cpu</span><br><span class="line">      target:</span><br><span class="line">        type: AverageUtilization</span><br><span class="line">        averageUtilization: 70</span><br><span class="line">……</span><br></pre></td></tr></table></figure>
对于场景2的问题，个人觉得是一个认知问题，容器化时代，开发人员需要知道自己的服务是如何容器化（个人认为这是容器化时代开发人员的基本修养），试想：作为开发人员的你，你定义好了<code>Dockerfile</code>以及k8s资源文件，有没有一种一切尽在掌握的感觉。</li>
</ol>
<h1 id="IaC推进的障碍？"><a href="#IaC推进的障碍？" class="headerlink" title="IaC推进的障碍？"></a>IaC推进的障碍？</h1><p>基础设施代码代码化这是一个趋势，<strong>可描述</strong>与<strong>可追溯</strong>这是一大优势，所以才会诞生“DevOps工程师”（一家之言），用于弥补开发的运维短板和运维的开发短板。但是没有让开发、运维、测试都参与进来，这其中一部分原因是由于工作职能划分的过于清晰，当然，也可能是部门墙，还有习惯的改变、新知识和概念的学习成本等，这些都是问题，以笔者浅见，解决这些问题的方法不是规避，新技术实施和推广，大家不免会有疑惑，或许让愿意接受的人来拥抱与参与会是一个好方法，用脚投票，只要是真正能带来效率提升的方法，相信没有人会拒绝的。</p>
<p>ps:<br>这是一个<em>后端开发</em>，曾在质量团队呆过，做过PaaS平台，给运维团队做过乙方后，对IaC的一点浅见，真的是浅见，但也因此爱上了IaC</p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://insights.thoughtworks.cn/nfrastructure-as-code/">https://insights.thoughtworks.cn/nfrastructure-as-code/</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Infrastructure_as_code">https://en.wikipedia.org/wiki/Infrastructure_as_code</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/">https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://wusphinx.github.io/2020/11/23/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CRD%E4%B9%8B%E4%B8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wusphinx">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="just for fun!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/23/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CRD%E4%B9%8B%E4%B8%80/" class="post-title-link" itemprop="url">后端开发视角下的CRD之一</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-23 13:18:34" itemprop="dateCreated datePublished" datetime="2020-11-23T13:18:34+08:00">2020-11-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-25 11:30:23" itemprop="dateModified" datetime="2020-12-25T11:30:23+08:00">2020-12-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          
            <span id="/2020/11/23/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CRD%E4%B9%8B%E4%B8%80/" class="post-meta-item leancloud_visitors" data-flag-title="后端开发视角下的CRD之一" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CRD是什么？"><a href="#CRD是什么？" class="headerlink" title="CRD是什么？"></a>CRD是什么？</h1><p>Custom Resource Definitionsr的简称，它是对Kubernetes API 的扩展。打个并不严谨的比方，从所周知<code>Service</code>、<code>Pod</code>、<code>Deployment</code>等是k8s内置的资源<strong>类型</strong>，因为k8s使用golang开发，如果把<code>Pod</code>类比为golang中的<code>int</code>类型，那么CRD可以类比为golang中的<code>interface</code>: 抽象类型，这个比喻可能不那么恰当，只是为了方便个人理解。而关于CRD的产生过程，还有一段非常有坡的故事，可参考认文末张磊老师的的<strong>Kubernetes API 与 Operator：不为人知的开发者战争</strong>链接</p>
<h1 id="如何编写自己的CRD？"><a href="#如何编写自己的CRD？" class="headerlink" title="如何编写自己的CRD？"></a>如何编写自己的CRD？</h1><p>对CRD有了初步了解之后，我们要如何写出自己想要的CRD呢？<br>就像我们写Http Server一样，有<code>Gin</code>等框架，写CRD同样也有对应的框架：kubebuilder。下面，我们一下一步来编辑自己的CRD</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="准备工具"><a href="#准备工具" class="headerlink" title="准备工具"></a>准备工具</h3><p>首先得自备一个k8s集群（笔者使用的是minikube）,根据自己的开发环境下载kubebuilder工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">os&#x3D;$(go env GOOS)</span><br><span class="line">arch&#x3D;$(go env GOARCH)</span><br><span class="line"></span><br><span class="line"># download kubebuilder and extract it to tmp</span><br><span class="line">curl -L https:&#x2F;&#x2F;go.kubebuilder.io&#x2F;dl&#x2F;2.3.1&#x2F;$&#123;os&#125;&#x2F;$&#123;arch&#125; | tar -xz -C &#x2F;tmp&#x2F;</span><br><span class="line"></span><br><span class="line"># move to a long-term location and put it on your path</span><br><span class="line"># (you&#39;ll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)</span><br><span class="line">sudo mv &#x2F;tmp&#x2F;kubebuilder_2.3.1_$&#123;os&#125;_$&#123;arch&#125; &#x2F;usr&#x2F;local&#x2F;kubebuilder</span><br><span class="line">export PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;kubebuilder&#x2F;bin</span><br></pre></td></tr></table></figure>
<h3 id="项目初始化"><a href="#项目初始化" class="headerlink" title="项目初始化"></a>项目初始化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir $GOPATH&#x2F;src&#x2F;example</span><br><span class="line">cd $GOPATH&#x2F;src&#x2F;example</span><br><span class="line">kubebuilder init --domain my.domain</span><br></pre></td></tr></table></figure>
<p>项目结构如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── Makefile</span><br><span class="line">├── PROJECT</span><br><span class="line">├── bin</span><br><span class="line">│   └── manager</span><br><span class="line">├── config</span><br><span class="line">│   ├── certmanager</span><br><span class="line">│   ├── default</span><br><span class="line">│   ├── manager</span><br><span class="line">│   ├── prometheus</span><br><span class="line">│   ├── rbac</span><br><span class="line">│   └── webhook</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── hack</span><br><span class="line">│   └── boilerplate.go.txt</span><br><span class="line">└── main.go</span><br></pre></td></tr></table></figure>
<h3 id="创建API"><a href="#创建API" class="headerlink" title="创建API"></a>创建API</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubebuilder create api --group webapp --version v1 --kind Guestbook</span><br></pre></td></tr></table></figure>
<p>到这一步，语义理解还是非常清楚的，就个人的理解：定义了一个RESTful的URI，类型、资源名称、Group等，很像我们平时写HTTP API的感觉，事实上，我们正在做的也确实在写一个API，目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── Makefile</span><br><span class="line">├── PROJECT</span><br><span class="line">├── api</span><br><span class="line">│   └── v1</span><br><span class="line">├── bin</span><br><span class="line">│   └── manager</span><br><span class="line">├── config</span><br><span class="line">│   ├── certmanager</span><br><span class="line">│   ├── crd</span><br><span class="line">│   ├── default</span><br><span class="line">│   ├── manager</span><br><span class="line">│   ├── prometheus</span><br><span class="line">│   ├── rbac</span><br><span class="line">│   ├── samples</span><br><span class="line">│   └── webhook</span><br><span class="line">├── controllers</span><br><span class="line">│   ├── guestbook_controller.go</span><br><span class="line">│   └── suite_test.go</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── hack</span><br><span class="line">│   └── boilerplate.go.txt</span><br><span class="line">└── main.go</span><br></pre></td></tr></table></figure>
<h3 id="自定义类型：Guestbook"><a href="#自定义类型：Guestbook" class="headerlink" title="自定义类型：Guestbook"></a>自定义类型：Guestbook</h3><p>以下即是我们新创建的CRD：Guestbook的类型结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Guestbook is the Schema for the guestbooks API</span><br><span class="line">type Guestbook struct &#123;</span><br><span class="line">	metav1.TypeMeta   &#96;json:&quot;,inline&quot;&#96;</span><br><span class="line">	metav1.ObjectMeta &#96;json:&quot;metadata,omitempty&quot;&#96;</span><br><span class="line"></span><br><span class="line">	Spec   GuestbookSpec   &#96;json:&quot;spec,omitempty&quot;&#96;</span><br><span class="line">	Status GuestbookStatus &#96;json:&quot;status,omitempty&quot;&#96;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来跟k8s内置类型<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/kubernetes/kubernetes@2db51c85b948f8180b427964b43f84e517c6e35e/-/blob/staging/src/k8s.io/api/apps/v1/types.go#L254:6">Deployment</a>对比一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Deployment enables declarative updates for Pods and ReplicaSets.</span><br><span class="line">type Deployment struct &#123;</span><br><span class="line">	metav1.TypeMeta &#96;json:&quot;,inline&quot;&#96;</span><br><span class="line">	&#x2F;&#x2F; Standard object metadata.</span><br><span class="line">	&#x2F;&#x2F; +optional</span><br><span class="line">	metav1.ObjectMeta &#96;json:&quot;metadata,omitempty&quot; protobuf:&quot;bytes,1,opt,name&#x3D;metadata&quot;&#96;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Specification of the desired behavior of the Deployment.</span><br><span class="line">	&#x2F;&#x2F; +optional</span><br><span class="line">	Spec DeploymentSpec &#96;json:&quot;spec,omitempty&quot; protobuf:&quot;bytes,2,opt,name&#x3D;spec&quot;&#96;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Most recently observed status of the Deployment.</span><br><span class="line">	&#x2F;&#x2F; +optional</span><br><span class="line">	Status DeploymentStatus &#96;json:&quot;status,omitempty&quot; protobuf:&quot;bytes,3,opt,name&#x3D;status&quot;&#96;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类型结构几乎是一模一样的，可以看到<code>metav1.TypeMeta</code>与<code>metav1.ObjectMeta</code>是内嵌结构体，这是类型的一些公共定义，篇幅有限，就不在此处不展开了，<code>Spec</code>是需要注意的，前面我们定义了一个资源及期接口，那<code>Spec</code>可以认为是接口的入参了，<code>Status</code>: 顾名思义，资源的状态</p>
<h3 id="入参校验"><a href="#入参校验" class="headerlink" title="入参校验"></a>入参校验</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">type GuestbookSpec struct &#123;</span><br><span class="line">	&#x2F;&#x2F; INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span><br><span class="line">	&#x2F;&#x2F; Important: Run &quot;make&quot; to regenerate code after modifying this file</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Foo is an example field of Guestbook. Edit Guestbook_types.go to remove&#x2F;update</span><br><span class="line">	&#x2F;&#x2F; 设定参数Foo的取值范围，也就是做入参校验</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; +kubebuilder:validation:MaxLength&#x3D;10</span><br><span class="line">	&#x2F;&#x2F; +kubebuilder:validation:MinLength&#x3D;1</span><br><span class="line">	Foo string &#96;json:&quot;foo,omitempty&quot;&#96;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处只有一个参数<code>Foo</code>，我们通过注解的方式设定Foo的取值范围为[1,10]</p>
<h3 id="安装CRD到k8s集群中"><a href="#安装CRD到k8s集群中" class="headerlink" title="安装CRD到k8s集群中"></a>安装CRD到k8s集群中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make install </span><br></pre></td></tr></table></figure>
<p>将<code>Guestbook</code>这种资源类型注册到自己的k8s中以使外部系统能够访问到<br>部署一个<code>Guestbook</code>实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f config&#x2F;samples&#x2F;</span><br></pre></td></tr></table></figure>
<p>这一步，以后端视角，就是调用<code>POST</code>接口新建一条”数据库”记录的，当然，k8s的数据库自然就是etcd了；如果我们将<code>foo</code>的值设为<code>asdfgasdfg1</code>，长度为11的字符串，再运行以上命令，会是什么结果呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The Guestbook &quot;guestbook-sample&quot; is invalid: spec.foo: Invalid value: &quot;&quot;: spec.foo in body should be at most 10 chars long</span><br></pre></td></tr></table></figure>
<p>可以看到入参校验生效了,</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>至此，我们完成了一个CRD的最基本定义，以后端开发的视角而言，如果将CRD可以看作是一张表，这张表作为资源，这一节完成了对CRD这类资源的基本定义跟校验。</p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/api-extension/custom-resources/">https://kubernetes.io/zh/docs/concepts/extend-kubernetes/api-extension/custom-resources/</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/jZLkS4SFVVXS1Mx2aG4PUA">Kubernetes API 与 Operator：不为人知的开发者战争（一）</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ODaOiwXMBhRFZjbdu1BFUA">Kubernetes API 与 Operator：不为人知的开发者战争（二）</a></li>
<li><a target="_blank" rel="noopener" href="https://book.kubebuilder.io/">kubebuilder</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/wusphinx/example-crd">https://github.com/wusphinx/example-crd</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://wusphinx.github.io/2020/11/19/%E5%8F%88%E4%B8%80%E4%B8%AACI-CD%E7%B3%BB%E7%BB%9F-Tekton/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wusphinx">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="just for fun!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/19/%E5%8F%88%E4%B8%80%E4%B8%AACI-CD%E7%B3%BB%E7%BB%9F-Tekton/" class="post-title-link" itemprop="url">又一个CI/CD系统-Tekton</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-19 09:23:38" itemprop="dateCreated datePublished" datetime="2020-11-19T09:23:38+08:00">2020-11-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-25 11:30:23" itemprop="dateModified" datetime="2020-12-25T11:30:23+08:00">2020-12-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a>
                </span>
            </span>

          
            <span id="/2020/11/19/%E5%8F%88%E4%B8%80%E4%B8%AACI-CD%E7%B3%BB%E7%BB%9F-Tekton/" class="post-meta-item leancloud_visitors" data-flag-title="又一个CI/CD系统-Tekton" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Tekton是什么？"><a href="#Tekton是什么？" class="headerlink" title="Tekton是什么？"></a>Tekton是什么？</h1><blockquote>
<p>Tekton 是一个强大且灵活的 Kubernetes 原生开源框架，可用于创建持续集成和交付 (CI/CD) 系统。该框架可让您跨多个云服务商或本地系统进行构建、测试和部署，而无需操心基础实现详情。</p>
</blockquote>
<p>从定义可知，Tekton是一种新的CI/CD系统，正如常见的Jenkins、Drone、GitLab CI做的事情一样，特殊之处在于它是生于Kubernetes，长于Kubernetes。</p>
<h1 id="安装Tekton"><a href="#安装Tekton" class="headerlink" title="安装Tekton"></a>安装Tekton</h1><p>因为Tekton运行环境依赖于k8s，所以我们首先必须得有一个k8s环境，笔者本地使用的是minikube，如下本地启动一个k8s</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube start -p k8s -v10 --image-mirror-country cn --iso-url&#x3D;https:&#x2F;&#x2F;kubernetes.oss-cn-hangzhou.aliyuncs.com&#x2F;minikube&#x2F;iso&#x2F;minikube-v1.6.0.iso  --image-repository registry.cn-hangzhou.aliyuncs.com&#x2F;google_containers --vm-driver&#x3D;hyperkit --registry-mirror&#x3D;https:&#x2F;&#x2F;dq4otk2m.mirror.aliyuncs.com --kubernetes-version&#x3D;1.16.0</span><br></pre></td></tr></table></figure>
<p>集群启动以后就可以安装Tekton，按照官网的描述，可按如下安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply --filename https:&#x2F;&#x2F;storage.googleapis.com&#x2F;tekton-releases&#x2F;pipeline&#x2F;latest&#x2F;release.yaml</span><br></pre></td></tr></table></figure>
<p>不过，因于Tekton需要依赖众多gcr站点镜像，安装过程需要先预先准备好这些镜像，笔者使用github的action将这些镜像转移到了阿里云的镜像中心，并将Tekton的安装文件重新换成了阿里云的镜像地址，项目地址为：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/wusphinx/tektoncd-cn">https://github.com/wusphinx/tektoncd-cn</a></p>
<p>国内码云地址为：</p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/wucentaur/tektoncd-cn">https://gitee.com/wucentaur/tektoncd-cn</a></p>
<p>项目目录如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">├── LICENSE</span><br><span class="line">├── README.md</span><br><span class="line">├── example</span><br><span class="line">│   ├── pipelineresource.yaml</span><br><span class="line">│   ├── task-test.yaml</span><br><span class="line">│   └── taskrun.yaml</span><br><span class="line">└── tekton</span><br><span class="line">    ├── tekton-dashboard-release.yaml</span><br><span class="line">    └── tekton.yaml</span><br></pre></td></tr></table></figure>
<p>如此，可以通过<code>kubectl apply -f tekton/</code>完成安装，顺带也把Tekton的dashboard也安装了，检查安装状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ kubectl get pods -n tekton-pipelines</span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">tekton-dashboard-5dcb9688bd-pls8b             1&#x2F;1     Running   1          18h</span><br><span class="line">tekton-pipelines-controller-6564b64ff-7gwbc   1&#x2F;1     Running   1          18h</span><br><span class="line">tekton-pipelines-webhook-5d6b9646b9-mr7jl     1&#x2F;1     Running   1          18h</span><br></pre></td></tr></table></figure>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>既然是CI/CD系统，那流水线一定是必不可少的，前面说到Tekton生于k8s，所以才有了CRD定义的流水线，我们先定义获取代码仓库的资源</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">tekton.dev/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PipelineResource</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tekton-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">url</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">https://github.com/wusphinx/multistage</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">revision</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">main</span></span><br></pre></td></tr></table></figure>
<p>简洁明了，如果代码仓库是gitlab，用gitlab ci来做，这一步是隐式的，用Jenkins的话，没有与gitlab集成的情况下，也需要显示配置。<br>定义流水线任务（只是为了演示，当然你可以自定义其它任务）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">tekton.dev/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Task</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">inputs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">repo</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run-test</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">golang:1.13-alpine</span></span><br><span class="line">    <span class="attr">workingDir:</span> <span class="string">/workspace/repo</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;GO111MODULE&quot;</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;on&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;GOPROXY&quot;</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;https://goproxy.cn,direct&quot;</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;go&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;mod&quot;</span>, <span class="string">&quot;download&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>任务的核心是对<em>某个</em>golang项目执行<code>go mod download</code>操作，<code>PipelineResource</code>跟<code>Task</code>缺少一纽带联系起来，这个纽带就是<code>TaskRun</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">tekton.dev/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">TaskRun</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testrun</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">taskRef:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">inputs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">repo</span></span><br><span class="line">      <span class="attr">resourceRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">tekton-example</span></span><br></pre></td></tr></table></figure>
<p>示例都准备好了，可以直接执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ kubectl apply -f example&#x2F;</span><br><span class="line">pipelineresource.tekton.dev&#x2F;tekton-example created</span><br><span class="line">task.tekton.dev&#x2F;test created</span><br><span class="line">taskrun.tekton.dev&#x2F;testrun created</span><br></pre></td></tr></table></figure>
<p>可通过dashboard查看任务执行结果如下所示：</p>
<p><img src="/images/tekton.png" alt="tekton"></p>
<p>回头来看资源的作用就很容易理解了</p>
<ul>
<li>PipelineResource： 流水线的资源，示例就是指代码仓库了</li>
<li>Task： 流水线要执行的任务与步骤定义</li>
<li>TaskRun：将资源与任务做关联并执行</li>
</ul>
<p>这么看若要完成一个流水线，至少要定义三类资源才行，这样代码跟CI/CD是分离的，需要在Tekton平台上做这些配置。当然因为Tekton本身就在k8s集群中，可以用尽k8s的资源调度优势，不过gitlab runner也可以安装在k8s中，从使用体验上来讲Tekton的优势并不明显，不过，这也是因为gitlab runner与gitlab是一家天然集成的缘故，Tekton的方式就是在做解耦，并无不妥。</p>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>如此看来，Tekton是另一个CI/CD系统，抽象粒度很细，从实际使用效果来看并未带来明显的好处。最大的优势在于原生支持k8s，不过其它CI/CD平台也在向k8s靠拢，这个优势也并不十分突出。一点浅见，欢迎拍砖。</p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/tekton">https://cloud.google.com/tekton</a></li>
<li><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/arayxto19bd6avbmxfqz">https://www.infoq.cn/article/arayxto19bd6avbmxfqz</a></li>
<li><a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/create-ci-pipeline-with-tekton-1/">https://www.qikqiak.com/post/create-ci-pipeline-with-tekton-1/</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://wusphinx.github.io/2020/11/17/%E6%88%91%E4%B8%8EEP%E7%9A%84%E7%BC%98%E4%BB%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wusphinx">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="just for fun!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/17/%E6%88%91%E4%B8%8EEP%E7%9A%84%E7%BC%98%E4%BB%BD/" class="post-title-link" itemprop="url">我与EP的缘份</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-17 16:48:49" itemprop="dateCreated datePublished" datetime="2020-11-17T16:48:49+08:00">2020-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-25 11:30:23" itemprop="dateModified" datetime="2020-12-25T11:30:23+08:00">2020-12-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a>
                </span>
            </span>

          
            <span id="/2020/11/17/%E6%88%91%E4%B8%8EEP%E7%9A%84%E7%BC%98%E4%BB%BD/" class="post-meta-item leancloud_visitors" data-flag-title="我与EP的缘份" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>EP亦即<strong>Engine Productivity</strong>的英文缩写，很多公司其称之为<strong>研发效能</strong>，我有幸在两家公司的效能小组效力过，以致于我在工作中会有一些习惯，比如自己搭建的k8s集群叫<code>ep</code>，测试环境容器化部署的环境变量也叫<code>ep</code>……，坦白讲，对这个职能背后的工作内容确实是有一些新鲜感，我的内心对<code>EP</code>更多的是敬畏之心。</p>
<p>记得去年初，因为厌倦了业务后端的开发工作，同时也有互联网从业人员的焦虑之心，更深一层，是因为在后端呆了四年，固然有运气的原因，不过还没有混到管理岗位这件事，让我对自身的能力产生了不自信，所以阴差阳错的，从成都来到杭州，进到了C公司质量部门的效能小组，title是资深测试开发工程师，所以其实这个效能是为测试服务的，不过真正做的事情，那就仁者见仁，智者见智了。</p>
<p>我接到的第一个任务做一个移动端APP自动化测试平台。我经过调研，了解到了Appium、Macaca、NoSmoke、Airtest、Fastmonkey等框架和工具，几乎把移动端的测试工具玩了个遍，甚至自己去写页面的深度遍历，写技术方案，最后我得出了一个结论：所谓的自动化并不能真正提高效率，而只是将大家手机测试任务归类、统一，或者说最后其实需要的是一个手机无接触测试管理平台。后续因为手机端日志平台以及其它原因，此事就此搁置了，于是，我又被分派去和另一个小伙伴做测试环境的容器化推进了。也就是在做这件事的过程中，我接触到了k8s，以为自己也有机会去推进DevOps文化，结果处处碰壁。首先遇到的是k8s的安装方案，要不要自己开发k8s的PaaS平台，当时我根据个人的经验判断是不需要，原因是人力不足以及有开源的Rancher可以用，不过另外一个同事已经投入了不少精力在PaaS平台上，所以我转而去推动容器化的设计和落地上了。当然，遇到的问题是，容器化并不算是真正的需求，只是测试团队一厢情愿想的想法，当时运维团队也在做容器化，差别就在于他们不碰业务，而我们要自己去做业务，部署到k8s中，调通，然后测试，这些都是琐碎的体力活，整个过程就不太顺利，因为容器化需要各方协作，但是容器化的整体意愿不是很强烈，加上部门墙的原因，进度是比较慢的；后来又遭遇部门领导离开，新来的领导并不看好测试部门来做容器化，明面上不反对，但也支持继续下去；在此情况下，有一同事离职，我需要兼顾她留下来的工作：安全平台，经过一番了解，这套平台是基于sonarqube来做的，参与的人还挺多，不过，从设计上看，是自己做了一套平台，底下还是sonarqube，换了一层皮，做了一些翻译和统计以及计分系统，以我做开发的感觉，使用上反而更复杂，当时就觉得这个平台是比较功利的，并没有解决啥问题，不过，因为参与人数众多，也不得不硬着头皮往下做。因为这些工作内容上的变化，感觉到自己做的事情没有太大意义，虽然测试部门做一个平台是一个亮点，但于我而言，对工作本身并没有认同感、自豪感，这份工作无法激起我的热情，于是心生去意，带着对容器化的热情，对自己这次转型的不满，毅然裸辞了。现在回过头来看，并非完全没有收获，接触到了那么多不同的领域，不一样的技术，也做了不少尝试，质量部门的效能理应优先对测试负责，虽然在我看来，格局略小。</p>
<p>今年8月，入职了W公司的技术保障中心的<strong>EP</strong>效能组，同样地，怀着一颗赤诚之心，我想大干一场。接到的活也是做一个平台：监控报警平台，公司内部本身有一套基于Zabbix的监控报警平台，是用Java写的，不过因为部门同时也在做容器化落地的事情，希望监控能用Prometheus来替代，所以其实是重写原有的监控报警平台，当时以为没有历史负担真好，因为需求已经定下来，于我而言，做实现就好了。于是乎，对Prometheus的生态做了一番调研，在测试环境自己使用，出服务设计方案，搭建环境等。当我深入其中，心头疑惑却越来越重，我要做的平台其实是一个运维主机监控平台（一期），从这个角度上来讲，没有这个平台，也可以完成目标，那做这一套的意义在哪呢？带着这个疑问，我去找了一些人，得到的回复是：主机监控最终是想开放给开发者用（因为当时还没有容器化，服务还是部署在主机中，主机与服务的关系是多对多），当然，我还了解到我所以在的部门，以前是运维部门，因为少有运维具备开发能力，于是招了一些开发，最终合并成了技术保障中心这个大部门。<br>于是，我明白了，效能并不是真的效能，说起来，只是运维的开发，怪不得领导经常打趣说运维是我们的<em>甲方</em>。所以才会有Nginx配置平台以及我做的监控报警平台，这些平台说是给运维做的GUI平台，可能有点夸张，但从效果上看，确实如此。在做这套平台的过程中，我花了一些时间研究GitOps和优化公司持续集成的方法，不过可惜的是，这些都还没有来的及实施，我就“离职”了。离职发生在我做入职答辩的那天，毫无征兆地，HR说我的答辩没有通过，由于公司没有多余的HC，限为本周五离职，当时我就惊呆了，甚至于觉得非常耻辱，我还是第一次遇到这种状况。我们老大找到我说，他之前也不知道，是因为公司打算上市，在做一些优化，也可能是安慰的话。我没有过多纠缠，也没有做申辩，只是觉得既然此处不欢迎我，那也没有呆下去的必要的，也不必再争取什么，果然在OA上提了离职。</p>
<p><img src="/images/ep.jpeg" alt="ep"><br>这两次呆在EP团队的经历，称不上有多愉快，甚至于对自身产生了一些怀疑，因为这些，换工作突然变得频繁，但我本身并没有那么不安份。回想起来，我只是想<strong>做正确的事</strong>，但没有<strong>正确的做事</strong>，这两者，也并非绝对对立，对于EP，我的敬畏之心仍在，甚至更甚从前，是它让我了解到，工作不能只限于眼前，同能不能好高骛远，找到真正有价值的情况，优先解决主要矛盾，获取信任，努力解决别人的问题，就能不断拓展自己的业务边界。</p>
<p>如果时间倒流，在C公司，我会花更多时间去了解各方真正的痛点，与上下达到目标的一致性，而不只是埋头做事；在W公司，我会争取平台最小化实现，推而广之，让真正的使用群众投票，再不生无效的疑问，抱无畏的希望。但是，没有如果，即使那么做了，也只是在做一份工作，并没有真正的<strong>EP</strong>。工作中的价值跟意义，或许，并没有那么重要吧，但是，心中还是会保留着一丝希望，这，是不是就是那份初心？</p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://sq.163yun.com/blog/article/224315717234970624">https://sq.163yun.com/blog/article/224315717234970624</a></li>
<li><a target="_blank" rel="noopener" href="https://landing.google.com/engprod/">https://landing.google.com/engprod/</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://wusphinx.github.io/2020/11/17/%E8%B0%88%E8%B0%88%E5%AE%B9%E5%99%A8%E5%8C%96%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%9D%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wusphinx">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="just for fun!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/17/%E8%B0%88%E8%B0%88%E5%AE%B9%E5%99%A8%E5%8C%96%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%9D%E8%B7%AF/" class="post-title-link" itemprop="url">谈谈容器化的实践思路</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-17 13:52:02" itemprop="dateCreated datePublished" datetime="2020-11-17T13:52:02+08:00">2020-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-25 11:30:23" itemprop="dateModified" datetime="2020-12-25T11:30:23+08:00">2020-12-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a>
                </span>
            </span>

          
            <span id="/2020/11/17/%E8%B0%88%E8%B0%88%E5%AE%B9%E5%99%A8%E5%8C%96%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%9D%E8%B7%AF/" class="post-meta-item leancloud_visitors" data-flag-title="谈谈容器化的实践思路" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>老实说，这是一个挺大的话题，盲目谈论有点大言不惭，不过，笔记打算从自己的工作经历中聊聊这个话题。</p>
<p>彼时，笔者还在成都，那时Golang还很新，版本还牌1.10以下，容器化在当时的技术领域是一项非常时髦的技术，当时我所在的团队，已经开始尝试服务容器化了，容器的管理平台使用的时开源的容器管理平台<a target="_blank" rel="noopener" href="https://docs.rancher.cn/">Rancher</a> 1.x版本（当时还没有使用k8s，不过运维团队已开始预研），当时团队自动化程度较高，<code>Dockerfile</code>也不是开发自己写的，而是由<strong>项目初始化工具</strong>生成Dockerfile及<code>.gitlab-ci.yml</code>模板，然后经由CI/CD平台（用的是gitlab runner）编辑打包然后部署，整个流程如下所示：</p>
<p><img src="/images/g7cicd.png" alt="g7"></p>
<p>当时测试环境有<code>test</code>、<code>demo</code>等，都是相互隔离的，以提交时的分支名确定应该部署到哪个环境，比如当时时<code>test</code>分支，提交代码之后，应用就部署到<code>test</code>环境。这一套流程最大的好处是从提交代码开始，CI/CD就开始进行，且中间没有阻隔，所以开发测试的效率非常高，迭代很迅速，这段工作经历是我的DevOps思想的启蒙。</p>
<p>来到杭州以后，第一份工作是在某操做容器化的推进，公司的技术栈以Java为主，推进容器化的动机是因为测试环境非常混乱，希望能够通过服务容器化，减少测试环境的机器，以达到节省成本的目的。（值得一提的是，当时还没有谈到推进容器化上生产这一步，对此我表示很惊讶）。当时测试环境的混乱情况到了何种地步，且我娓娓道来：</p>
<p><img src="/images/caocaocicd.png" alt="caocaocicd"></p>
<p>其中选择空闲机器这一步，因为机器不足分布不均的有关系，会出现张三将机器上某个应用A杀掉从而部署应用B；触发jenkins任务这一步经常会失败，因为这一步通常是由测试人员去完成的，编译打包过程出现一些问题也在所难免，最后又得找到开发；再说部署这一步，因为应用部署前需要将自己注册到网关，这一步因为某些原因经常出现异常，从而导致部署中断，此时测试人员又得找到运维……我描述的还只是当时所见到的一小部分，这种混乱主要原因在于开发、运维、测试的割裂，各自完成自己所做的那一部署然后就不管了，由于常见的部门墙等因素，跨部门合作也不算很容易，所以经常可见的项目延期上线，以我的角度，DevOps几近于没有，因为我没有看到合作，团队和部门都是各自为政，当然，这也并非个案。<br>在这种情况下要推进容器化并非易事（话又说回来，要是容易的话，也就没我什么事了）。出于个人经验，你首先想到的是改造CI/CD，将我在前司的研发流程带到公司。于是，从DevOps的受益者变成设计者，我首先完成了一套基于gitlab的CI/CD流程的demo，在团队内做了一次分享，不过可惜的是，当时团队成员觉得思路挺好，就是和现有以Jenkins为主的流程有些差异，不容易为人所接受。现有想想，当时也确实过于激进，毕竟我所接触到的同事，他们也只用过Jenkins，而且由于职能的原因，每个人相对只关心于自己的任务线。虽说有点受挫，不过笔者当时并没有放弃，而是找gitlab的维护人员，希望他们能够安装gitlab runner，不过得到的回复是：我们现在已经有了jenkins，没有必要也不能安装gitlab runner了……</p>
<p><img src="/images/caocaocicd-paas.png" alt="caocaocicd-paas"></p>
<p>没法，容器化总也要推进，根据当时的服务容器化的需求，当然，是直接上k8s的，我们首先做的一件事情是进行硬件资源评估，然后申请机器部署k8s集群，然后着手公司服务拓扑图，没想到在这一步遇到了难题，由于业务线各自为政，没有一个全局的服务依赖关系，无奈之下，经过商议，为了证明容器化的可用性，只好先将某一个业务线的服务部署到我们的k8s集群中，由于业务不熟悉，期间也花了不少时间在打包以及调试上。<br>其中渲染资源文件模板本来是可以用helm的chart包来替代的，不过自己写<code>deployment</code>、<code>service</code>、<code>ingress</code>模板其实也可以达到目的，只不过因为要部署到k8s的关系，需要另做一套平台来部署，其实并没做DevOps，只是硬生生的将原有的那一套流程搬到容器化中而已，所以，即使我离职已经一年有余，这一套流程听说也没有最终落地，实在令人唏嘘。</p>
<p>前司某医的容器化之路也是坎坷，项目起步于2018年，容器化的动机据不完全了解是为了让公司跟上技术的发展潮流。公司技术栈同样以Java为主，不过还有少数php、golang以及python应用（当然，我用golang写的监控服务必须是容器化的）。整个流程如下所示</p>
<p><img src="/images/weiyicicd.png" alt="weiyicicd"></p>
<p>所谓个性化部署参数这里要特别解释一下：就是写一个<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/api-extension/custom-resources/">CRD</a>，这个CRD定义了一些参数如：appname、requests、limits、port等，简单说就是将deployment的参数以CRD的形式暴露出来，最后形成所下所示的k8s资源：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">appname:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line"> <span class="attr">template:</span></span><br><span class="line">   <span class="attr">spec:</span></span><br><span class="line">     <span class="attr">containers:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">         <span class="attr">image:</span> <span class="string">myapp:5.0.3</span></span><br><span class="line">         <span class="attr">ports:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">         <span class="attr">resources:</span></span><br><span class="line">           <span class="attr">limits:</span></span><br><span class="line">             <span class="attr">memory:</span> <span class="string">600Mi</span></span><br><span class="line">             <span class="attr">cpu:</span> <span class="number">1</span></span><br><span class="line">           <span class="attr">requests:</span></span><br><span class="line">             <span class="attr">memory:</span> <span class="string">300Mi</span></span><br><span class="line">             <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line"><span class="string">……</span></span><br></pre></td></tr></table></figure>
<p>如果定义一个服务也有三类资源如：<code>deployment</code>、<code>service</code>、<code>ingress</code>，那么这个CRD的作用就在于依据入参生成这三类资源并且部署到k8s集群中，由controller来保证每个应用，这三种资源都保持与CRD的定义一致。这也是容器化的一种思路，也是典型的CRD应用。<br>坦白说，就算不写CRD，也能达到这个目的，写CRD的目的是为了将应用模型进行统一，形式上就是尽可以将通用的资源参数暴露出来以供个性化使用，无奈之处在于还是在走容器化适配应用的路数，还不是将应用进行容器化适配，比如，dubbo的服务发现由zk提供，不过zk目前是在k8s外围，从功能上来讲，zk一定程序上跟k8s的service存在重复；应用内存使用是4G起步，虽说是为了保险起见，不过，这说明服务本身过重了，当然，硬件资源充足的情况下，这也不算是很大的问题；dubbo有自己的负载均衡，jvm可能也能限制资源的使用，作为容器化的拥趸，我不禁对java容器化的意义产生了一丝怀疑，诚然，k8s可以做hpa，可以自动重启，这些都是优势，但是到底真正的收益在哪里呢？<br>（截止文章发布之日，前司的容器化之路依然还在进行中）</p>
<p>容器化固然只是一句口号而已，而这句口号，却常常伴随着DevOps这个词语，依我个人的浅见，DevOps是一种开放合作的文化，它打破了软件开发过程中的各个职能界限，最终是为了提高工作效率，从提高工作效率这个角度来看，DevOps在我的职业生涯中依旧少见。</p>
<p>毫不掩饰的说，我对Jenkins有一丝偏见，因为我从事的公司中，使用Jenkins的方式无一例外，都是反DevOps的，设置流程的障碍，需要多方介入，但这种使用形成了一种习惯，我并不反对Jenkins，但如果使用Jenkins让事情变得更容易，我自然欣然接受，比如使用gitlab的CI/CD，就让人觉得很舒服，扩展性也挺好，这也是一个习惯问题。</p>
<p>前司的容器化之路依旧在进行中，而我，也有自己对于容器化的想法，如下所示</p>
<p><img src="/images/dreamcicd.png" alt="dreamcicd"></p>
<p>以轻巧的<a target="_blank" rel="noopener" href="https://k3s.io/">k3s</a>作为CI平台，可以将gitlab runner接入进来，当然，每个应用有自己对于CI的需求，对于资源的需求，所以项目repo中也应该包含<code>.gitlab-ci.yml</code>、<code>Dockerfile</code>等，选择k3s来做CI的运行平台自然是为了利用k8s的资源调度和扩展性了；选择gitops是为了将CI/CD解耦，这样，就有DevOps内味了。</p>
<p>自己的一点浅见，欢迎各位拍砖！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://wusphinx.github.io/2020/11/11/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E7%9A%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wusphinx">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="just for fun!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/11/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E7%9A%84/" class="post-title-link" itemprop="url">我是如何设计监控平台的</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-11 13:28:07" itemprop="dateCreated datePublished" datetime="2020-11-11T13:28:07+08:00">2020-11-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-25 11:30:23" itemprop="dateModified" datetime="2020-12-25T11:30:23+08:00">2020-12-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          
            <span id="/2020/11/11/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E7%9A%84/" class="post-meta-item leancloud_visitors" data-flag-title="我是如何设计监控平台的" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>老实说，刚接到监控平台这项工作内容的时候，只是过了一下产品的设计，产品的设计大部分借鉴的腾讯某监控平台，然后说是要做一套监控平台，以替代现有的Zabbix监控平台，那其实公司的现状是，公司有自己的机房，生产业务大部分都部署在物理机/虚拟机，现在向容器化迈进（听说做了两年），也有接入腾讯云、华为云等云厂商，目前监控用的是Zabbix, 因为在推容器化，k8s平台的监控首选Prometheus了，正因如此，所以要将再有的监控（只是主机监控）全面转向Prometheus，这个理由，不可谓不充分。</p>
<p>事情已经摆在眼前了，就是要基于Prometheus做一套监控平台，平台的作用是让监控可配置，在公司推广，让其它人能用起来。于是乎，开始折腾起Prometheus起来了，先来认识一下：</p>
<blockquote>
<p>Prometheus受启发于Google的Brogmon监控系统（相似的Kubernetes是从Google的Brog系统演变而来），从2012年开始由前Google工程师在Soundcloud以开源软件的形式进行研发，并且于2015年早期对外发布早期版本。2016年5月继Kubernetes之后成为第二个正式加入CNCF基金会的项目，同年6月正式发布1.0版本。2017年底发布了基于全新存储层的2.0版本，能更好地与容器平台、云平台配合。</p>
</blockquote>
<p>先盗一张官网的架构图</p>
<p><img src="/images/prometheus.png" alt="prometheus"></p>
<p>监控报警就是Prometheus Server</p>
<ol>
<li>收集目标exporter的数据</li>
<li>判断阈值</li>
<li>触发报警</li>
<li>Alertmanager推送消息</li>
</ol>
<p>整体构架还是清晰明了的，从产品的核心需求来看，平台提供的能力要满足以下几点：</p>
<ol>
<li>自定义监控规则</li>
<li>自定义报警规则</li>
<li>自定义报警通知</li>
<li>自定义报警频率</li>
</ol>
<p>由于产品目标用户的特殊性，服务部署在物理机/虚拟机/云主机上，单台主机会存在部署多个服务的情况，本质上是在做主机监控，但是要开放给业务开发使用，也就是业务要跟主机监控绑定。好了，拿到需求，要马上做吗？老司机都不急于动手，先想清楚一些问题：</p>
<ol>
<li>业务开发是否真实关心主机状况，例如cpu过载/内存过载等问题？</li>
<li>主机监控及报警配置是否在存在大量差异化需求，如：a机器cpu利用率超过80%报警，b机器cpu利用率超过60报警？</li>
<li>主机与服务是多对多的关系，这就会存在监控告的是别人的警，跟自己没关系的情况？<br><img src="http://processon.com/chart_image/5fab81cd7d9c0865e9bc0dba.png" alt="node2app"></li>
</ol>
<p>经过了解，问题1并非由开发提出，但你要说不存在这样的需求也的确欠妥，毕竟目前主机监控是由运维在负责，现在运维希望将主机监控将由开发去负责；问题2，本来差异是比较小的，不过由于需求1的存在，的确存在这种可能；问题3，基本无解，由于问题1的存在，3也不算问题。</p>
<p>无论如何，还是要实际使用一下Prometheus的，好在容器做强部署还是非常方便快捷的，不过又发现一些问题？</p>
<ol>
<li>prometheus规则配置目前只直接配置文件的形式，这对于业务平台来说并不太友好，如果支持关系型数据库也好呀</li>
<li>主机与服务间的关系由内部第三方服务管理，主机目标配置目前还是以文件存ip的形式，这对于报警查询及配置来说，都不友好</li>
<li>主机监控要考虑到不同环境，不同机房的统一管理，Prometheus该如何使用？</li>
</ol>
<p>针对以上问题，在一番斟酌后，我拿出了自己的设计：</p>
<p><img src="/images/alert_design.png" alt="监控设计"></p>
<p>红框部分即是需要参与编码服务或模块。</p>
<ol>
<li>alert-service: 跟前端交互的服务</li>
<li>alert-engine: RESTful API服务</li>
<li>alert-webhook: 用于接收alertmanager的webhook</li>
<li>minio: 用于报警规则配置</li>
<li>consul: Prometheus的服务发现</li>
</ol>
<p>首先，Prometheus需要联邦部署，这是一个树形结构，所有子Prometheus数据都上送到根Prometheus，这样，外部只需要与根Prometheus打交道即可，这解决了不同Prometheus集群统一管理的问题；</p>
<p>引入consul是为了解决Prometheus的服务发现问题，所谓服务发现是为了让Prometheus发现自己需要从哪些目标抓数据，同时也可以很方便地给目标打上自己想要的标签，如机房，应用名等信息，如果不用consul，也可以使用文件配置，使用文件配置的问题在于需要人为处理，不容易与外部系统对接，不够灵活。</p>
<p>引入minio是为了解决规则配置的问题，再有规则配置使用文件配置，也需要人手工操作，如果不使用minio这类文件系统，就需要ssh远程登录到配置所在主机，然后修改规则配置，不过在程序中使用ssh并不友好（也考虑过用git来管理规则配置，由于时间关系，这个方案并没有施行)</p>
<p>alert那三个服务本可以合三为一的，为什么要拆成三个呢？<br>alert-webhook只是接收alertmanager报警然后将期扔到kafka中，如果只有一个服务的话，那么在需求迭代服务重启时，就可能会丢掉报警。<br>alert-engine单纯提供RESTful API服务，比较稳定，这样的好处是上层如何变，下层不用有较大改变或者只需要关注自身业务即可，如此，如些，告警的接收、发送、配置也就彻底解耦了。</p>
<p>至于表的设计，由于依托于Prometheus，可以参照报警规则的结构体来建表，通知渠道根据自己的需求进行一些设计，最终需要与Prometheus保持一致，保证报警消息最终能发给目标用户。</p>
<p>这套系统对于业务方而言，可能作用不大，因为主机报警这类信息对于业务方开发而言，他们即使收到消息，并不能解决问题，如果能有阈值触发时，保存现场，比如火焰图，对开发者而言应该是有帮助的。</p>
<p>主机监控跟应用监控还是有很大区别的，目标用户在根本上是不一样的，当然，这两者也有结合的可能，比如日志聚合系统<a target="_blank" rel="noopener" href="https://grafana.com/oss/loki/">Loki</a>，师承Prometheus，如果跟运维监控相结合，有很大的想像空间，比如，可以统一监控的入口，信息聚合等。</p>
<p>监控报警的意义最终是要能解决问题，从这个角度讲，我的这个设计目前只能暴露问题，解决问题需要接外部系统，比如，自动扩缩容、服务降级、问题跟踪等，最终能形成闭环，让问题能够真正得到处理以及最终解决，还有不少事情需要做。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://wusphinx.github.io/2020/11/05/%E5%90%8E%E6%B5%AA-GitOps/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wusphinx">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="just for fun!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/05/%E5%90%8E%E6%B5%AA-GitOps/" class="post-title-link" itemprop="url">后浪-GitOps</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-05 10:32:40" itemprop="dateCreated datePublished" datetime="2020-11-05T10:32:40+08:00">2020-11-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-25 11:30:23" itemprop="dateModified" datetime="2020-12-25T11:30:23+08:00">2020-12-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a>
                </span>
            </span>

          
            <span id="/2020/11/05/%E5%90%8E%E6%B5%AA-GitOps/" class="post-meta-item leancloud_visitors" data-flag-title="后浪-GitOps" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>说到GitOps就一定要提DevOps了，如果说DevOps是前浪，那GitOps就是后浪了。为了表达对前辈的尊重，我们再次回顾一下DevOps：</p>
<blockquote>
<p>DevOps（Development和Operations的组合词）是一种重视“软件开发人员（Dev）”和“IT运维技术人员（Ops）”之间沟通合作的文化、运动或惯例。透过自动化“软件交付”和“架构变更”的流程，来使得构建、测试、发布软件能够更加地快捷、频繁和可靠。</p>
</blockquote>
<p>诚然，DevOps是一种讲究合作的文化，一定程序上打破了开发、运维、测试等软件开发的职能界限，让整个软件开发的流程更快，以此为标尺，我们可以度量一个公司是存在DevOps文化，是否在推动、践行DevOps文化。</p>
<p>回归正题，说到浪，没有前浪，哪来后浪，没有DevOps， GitOps也只是空谈，那么GitOps到底是翻的是哪种浪花？</p>
<p>GitOps的思想源自于一家叫做Weaveworks的公司，这家公司开源了一个名为Flux的GitOps的Operator，它运行在Kubernetes或OpenShift集群内。作用是提供自动监控，保证Kubernetes集群的状态与Git中提供的配置相匹配。</p>
<p>但GitOps不仅仅是Flux，也不仅仅是ArgoCD等同类工具。得益于从DevOps以及可靠性工程的思想经验，GitOps已经成为云原生开发的最新热点趋势。</p>
<p>如果它不是简单的工具，那么GitOps到底是什么？采用它所倡导的最佳实践会给DevOps团队及其构建的应用带来哪些优势？</p>
<h1 id="GitOps到底是什么？"><a href="#GitOps到底是什么？" class="headerlink" title="GitOps到底是什么？"></a>GitOps到底是什么？</h1><p>Weaveworks将GitOps总结为Kubernetes和其他用于云原生开发的技术的一种运营模式，</p>
<ul>
<li>提供一套最佳实践，为容器化集群和应用统一部署、管理和监控。</li>
<li>提供了一条端到端的CI/CD管道以及Git工作流。</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/44480-20616a21c53e7fcf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>对GitOps的扩展定义是，它是一个为云原生应用实现持续部署的标准，它注重以开发者为中心的基础设施运营体验。通过使用开发者已经熟悉的工具–Git以及持续部署工具（可选工具很多，比如我们正在用的Jenkins，但我推荐GitLab）–来实现Kubernetes集群管理及应用交付。</p>
<p>Git担负起声明式基础设施和应用的唯一定义工具。任何Git和K8s集群中实际运行的内容之间的差异都会被监测到。然后Kubernetes控制器可以回滚集群以与Git相匹配，或自动更新它。</p>
<p>将Git置于交付管道的中心，允许开发人员使用他们熟悉的工具（不用重新学习，没有认知负担）进行拉取请求。一个自动化的流程将仓库中的描述状态与生产环境进行匹配。 GitOps被描述为 “在生产环境中管理应用程序的控制器”。</p>
<h1 id="GitOps原则分解"><a href="#GitOps原则分解" class="headerlink" title="GitOps原则分解"></a>GitOps原则分解</h1><p>GitOps管理Kubernetes集群的工作流程基于以下4个原则。</p>
<p>#1 声明式描述整个系统</p>
<p>GitOps与包括Kubernetes在内的云原生工具经常代表的声明式系统合作。声明式系统可以被视为代码，因为配置是由事实而不是指令来保证的。当一个应用程序用声明的方式在Git中进行版本化时，那它就一定是明确的-这就是GitOps的核心所在。</p>
<p>由于声明或者说是定义真实明确的记录在Git中，应用程序可以很容易地从Kubernetes部署或者回滚。在最坏的情况下，集群的基础架构可以从Git仓库中准确而快速地恢复。</p>
<p>#2 Git决定了系统状态</p>
<p>如果生产版本的声明（K8s中的资源部署）与Git版本（声明式定义）有出入，就应该发出警报。如果需要回滚，简单的Git还原就能恢复正确的系统声明。</p>
<p>Git强大的安全性意味着代码的作者和出处始终是可追踪的，这意味着系统的每一次变更都有迹可寻。</p>
<p>#3 自动化部署</p>
<p>以Git作为生产集群必须准确反映声明的状态，对该状态的更改可以自动更新部署。由于状态定义存在于生产环境之外的Git中，所以系统变更时不需要集群凭证。所以，GitOps可以实现做什么和怎么做的分离。</p>
<p>#4 软件代理如果出现分歧就会报警</p>
<p>如果生产集群的实际情况与你所期望的系统软件不一致，可以发出警报。这样就能整个系统的自我修复，包括在发生人为错误的情况下。</p>
<h1 id="GitOps工作流"><a href="#GitOps工作流" class="headerlink" title="GitOps工作流"></a>GitOps工作流</h1><p><img src="https://upload-images.jianshu.io/upload_images/44480-b3660d76c74e64f8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h1 id="为什么要在云原生开发中采用-GitOps？"><a href="#为什么要在云原生开发中采用-GitOps？" class="headerlink" title="为什么要在云原生开发中采用 GitOps？"></a>为什么要在云原生开发中采用 GitOps？</h1><p>我们已经介绍了GitOps的特点，但具体的商业案例对系统的好处是什么？你很难找到一种持续部署技术或方法论不承诺更快、更频繁的部署（真实需求就是快速频繁的迭代和部署）。GitOps也不例外，但有很多东西可以支持这个承诺。</p>
<p>自动交付管道会将Git上的变更推送到你的基础架构中。GitOps更进一步。它使用像 Weaveworks 的 Flux 这样的工具来自动比较集群的状态和 Git 配置。集群中的操作者会触发Kubernetes内部的部署，从而使任何其他CD工具的需求变得多余。</p>
<p>这意味着CI不需要访问集群。每一次更新都是原子的、事务性的，并且在Git提交日志中。要么成功，要么失败。由于完全基于代码，不需要增加新的基础设施。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/44480-1dfd2a5f1fbebc9e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>Git作为基础架构和应用代码的 “真相之源”，可以加快部署和可靠性，因为任何错误都会被迅速发现。这样一来，无论是回滚生产状态还是从Git上更新，都非常容易</p>
<h1 id="XOps"><a href="#XOps" class="headerlink" title="XOps"></a>XOps</h1><p>无论是DevOps还是GitOps亦或是AIOpx，最终的目的都是为了Ops，将软件产品提供给受众，在X这一端也可以说是部署之前有很多种方法以及工具，我们姑且将X理解为CI，那Jenkins作为这一领域的前浪，依旧发挥着能量，不过后浪GitLab的发展也是迅猛</p>
<p><img src="https://upload-images.jianshu.io/upload_images/44480-c5ac73f0e8f76b69.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>公司目前使用的CI工具正是Jenkins，当我试图使用jenkins去实践DevOps甚至是GitOps,  我需要做以下几件事</p>
<ol>
<li>登录Jenkins平台上，新建一个PipeLine流水线；</li>
<li>配置好代码仓库demo以及代码访问权限；</li>
<li>编写Jenkinsfile；</li>
<li>因为测试环境Jenkins暂时没有与我们的代码仓库GitLab做集成，所以我不得不找到自己的项目，新建一个webhook，指向步骤1）的任务</li>
<li>因为需要知道流水线最终的运行结果，还需要配置任务通知</li>
</ol>
<p>对于我而言，有以下几个问题：</p>
<ol>
<li>我给项目demo配置了Jenkins流水线，这个项目也可能有其它贡献者，如果我不写文档，他们可能并不知道这件事，结果就需要问我，如同我给其它项目贡献需要问其它人一样。</li>
<li>其它人就算知道我配置了Jenkins流水线，总还得知道Jenkins服务的地址以及开通对应的权限</li>
</ol>
<p>所以测试环境常规发布过程归纳起来就是：</p>
<ol>
<li>开发完成，push代码；</li>
<li>登录Jenkins，选择分支，并完成发布</li>
<li>关注发布结果</li>
</ol>
<p>当然，这样做依然可以达到最终完成部署的目的。</p>
<p>可以设想一下，当一个新人开发者拿到代码仓库时，他没法快速知道整个CI/CD流程，但是实际上这些CI/CD流程是相对固定，是有规律可循可以用语言描述的的，是可以固化在代码仓库里面的，这就是为什么我更倾向于使用GitLab CI/CD的原因。</p>
<ol>
<li>天然与GitLab集成(与GitLab同出一家)</li>
<li>符合Iac(基础设施即代码)的哲学</li>
</ol>
<p><img src="https://upload-images.jianshu.io/upload_images/44480-dcef583873b9af79.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>CI/CD各阶段需要做的事情在.gitlab-ci.yml文件中</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">.....</span></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy-dev</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy-prod</span></span><br><span class="line"><span class="attr">lint:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">harbor.yourprivate.com/base/golangci-lint:v1.21-alpine</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">golangci-lint</span> <span class="string">run</span> <span class="string">-v</span></span><br><span class="line">  <span class="attr">allow_failure:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">.</span> <span class="string">-t</span> <span class="string">harbor.yourprivate.com/alert-service/gitops:$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">login</span> <span class="string">--username=$DOCKER_PRIVATE_USEE</span> <span class="string">harbor.yourprivate.com</span> <span class="string">--password</span> <span class="string">$DOCKER_PRIVATE_KEY</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">harbor.yourprivate.com/alert-service/gitops:$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA</span></span><br><span class="line"><span class="attr">deploy-dev:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy-dev</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">cnych/kustomize:v1.0</span></span><br><span class="line">  <span class="attr">before_script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">remote</span> <span class="string">set-url</span> <span class="string">origin</span> <span class="string">https://$&#123;CI_USERNAME&#125;:$&#123;CI_TOKEN&#125;@git.myprivate.com/wuql/gitops.git</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.email</span> <span class="string">&quot;gitlab@git.k8s.local&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.name</span> <span class="string">&quot;GitLab CI/CD&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">checkout</span> <span class="string">-B</span> <span class="string">$CI_COMMIT_BRANCH</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">pull</span> <span class="string">origin</span> <span class="string">$CI_COMMIT_BRANCH</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cd</span> <span class="string">deployment/dev</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kustomize</span> <span class="string">edit</span> <span class="string">set</span> <span class="string">image</span> <span class="string">harbor.yourprivate.com/alert-service/gitops:$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat</span> <span class="string">kustomization.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">commit</span> <span class="string">-am</span> <span class="string">&#x27;[skip ci] DEV image update&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">push</span> <span class="string">origin</span> <span class="string">$CI_COMMIT_BRANCH</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-prod:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy-prod</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">cnych/kustomize:v1.0</span></span><br><span class="line">  <span class="attr">before_script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">remote</span> <span class="string">set-url</span> <span class="string">origin</span> <span class="string">https://$&#123;CI_USERNAME&#125;:$&#123;CI_TOKEN&#125;@git.myprivate.com/wuql/gitops.git</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.email</span> <span class="string">&quot;gitlab@git.k8s.local&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.name</span> <span class="string">&quot;GitLab CI/CD&quot;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">checkout</span> <span class="string">-B</span> <span class="string">$CI_COMMIT_BRANCH</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">pull</span> <span class="string">origin</span> <span class="string">$CI_COMMIT_BRANCH</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cd</span> <span class="string">deployment/prod</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kustomize</span> <span class="string">edit</span> <span class="string">set</span> <span class="string">image</span> <span class="string">harbor.yourprivate.com/alert-service/gitops:$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat</span> <span class="string">kustomization.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">commit</span> <span class="string">-am</span> <span class="string">&#x27;[skip ci] PROD image update&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span> <span class="string">push</span> <span class="string">origin</span> <span class="string">$CI_COMMIT_BRANCH</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure>
<p>忽略细节部分，这段描述可以相对容易地理解为做了以下几件事</p>
<ol>
<li>Test：此处是静态检查）</li>
<li>Build：构建镜像</li>
<li>Deploy：根据分支名部署到对应环境(master分支的部署需要手动执行)</li>
</ol>
<p><img src="https://upload-images.jianshu.io/upload_images/44480-7267dd120779e465.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>虽然Weaveworks最早提出了GitOps这一理念，也有许多GitOps工具，比如flux、argocd、jenkins-X， 我们选用其中的argocd。</p>
<p>目前公司的CI/CD平台使用的是jenkins,  虽然也可以用，但是需要在jenkins配置任务以及仓库的代码访问权限，相对繁琐，其实公司的代码托管平台gitlab不仅仅可以用来做代码仓库，也可以做CI/CD, 因此，我自己搭建了gitlab runner将集成到公司的gitlab，项目代码目录如下</p>
<p><img src="https://upload-images.jianshu.io/upload_images/44480-7086a6e1ebf1fc17.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>其中main.go为http server代码</p>
<p>Dockerfile将仓库代码通过Multistage打包成开箱即用的窗口镜像</p>
<p>deployment为k8s部署的资源描述，dev为开发环境，prod为生产环境，对应的，我们需要在argocd的管理平台上新建两个应用</p>
<p><img src="https://upload-images.jianshu.io/upload_images/44480-ec56cebc0052ca72.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>背后就是在k8s中创建了applications.argoproj.io这个crd的实例</p>
<p>应用的描述如下所示</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">destination:</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://kubernetes.default.svc</span></span><br><span class="line">  <span class="attr">project:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">source:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">deployment/dev</span></span><br><span class="line">    <span class="attr">repoURL:</span> <span class="string">https://git.myprivate.com/wuql/gitops.git</span></span><br><span class="line">    <span class="attr">targetRevision:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">syncPolicy:</span></span><br><span class="line">    <span class="attr">automated:</span></span><br><span class="line">      <span class="attr">prune:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">selfHeal:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>当有人误将生产应用删除的时候，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deploy gitops -n dev</span><br></pre></td></tr></table></figure>
<p>argocd会监测到这一情况<br><img src="https://upload-images.jianshu.io/upload_images/44480-14cf26e14e2975e8.png!thumbnail?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片"></p>
<p>并重新将应用资源建立起来</p>
<p><img src="https://upload-images.jianshu.io/upload_images/44480-8515b1fbe1950a5f.png!thumbnail?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片"></p>
<p>至此，算是实践了一下gitops的思想。</p>
<h1 id="解决了什么问题？"><a href="#解决了什么问题？" class="headerlink" title="解决了什么问题？"></a>解决了什么问题？</h1><p>仔细想想，如果我们不用gitops这一套思路，gitlab runner本身就在k8sk, 我可以在gitlab的ci完成后直接apply部署，这样最终也能达到部署这一目的，gitops思路很大的一点不同在于【部署】这件事由opertaor来保证，并且持续检查部署状态是否与git仓库定义的是否一致，如果说在gitlab runner中可以一气呵成完成CI/CD, 那么gitops就是将CI/CD解耦了，这样带来的好处是否大于收益，个人认为需要看基础设施是否完善，如果本身CI/CD本身都做的很好，可以尝试，但是根据笔者的观察，IaC的思路并不是那么容易被接受的，思路可以借鉴，自动化确实很美好，不过也是道阻且长，最重要还是能解决团队当时当下的具体问题。</p>
<p>参考</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/DevOps">https://zh.wikipedia.org/wiki/DevOps</a></li>
<li><a target="_blank" rel="noopener" href="https://www.weave.works/technologies/gitops/">https://www.weave.works/technologies/gitops/</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/develop/develop-images/multistage-build/">https://docs.docker.com/develop/develop-images/multistage-build/</a></li>
<li><a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-cd/getting_started/">https://argoproj.github.io/argo-cd/getting_started/</a></li>
<li><a target="_blank" rel="noopener" href="https://kruschecompany.com/gitops/">https://kruschecompany.com/gitops/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/gitlab-ci-argo-cd-gitops/">https://www.qikqiak.com/post/gitlab-ci-argo-cd-gitops/</a></li>
<li><a target="_blank" rel="noopener" href="https://about.gitlab.com/devops-tools/jenkins-vs-gitlab/">https://about.gitlab.com/devops-tools/jenkins-vs-gitlab/</a></li>
<li><a target="_blank" rel="noopener" href="https://about.gitlab.com/stages-devops-lifecycle/continuous-integration/">https://about.gitlab.com/stages-devops-lifecycle/continuous-integration/</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">wusphinx</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wusphinx" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wusphinx" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wu.sphinx@gmail.com" title="E-Mail → mailto:wu.sphinx@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/U2qmNVI9YrCrKqf" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;U2qmNVI9YrCrKqf" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="rss fa-fw"></i>RSS</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wusphinx</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">50k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">45 分钟</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"uc2D6XEyHmm91AIetiqdcCWm-9Nh9j0Va","app_key":"HqBfxttp3OG10VMeG4Nv0dfq","server_url":"https://uc2d6xey.lc-cn-e1-shared.com","security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
